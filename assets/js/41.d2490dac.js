(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{785:function(e,t,s){"use strict";s.r(t);var v=s(51),_=Object(v.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("p",[e._v("通常在 unix系统上部署一个程序后，希望有便捷的启动，停止，重启，状态查询等功能。使用系统自带的 systemd服务便是解决方案之一。")]),e._v(" "),s("p",[e._v("大概步骤如下：")]),e._v(" "),s("ul",[s("li",[e._v("创建一个系统服务描述文件，eg: "),s("code",[e._v("/etc/systemd/system/app.service")])]),e._v(" "),s("li",[e._v("启动服务， "),s("code",[e._v("sudo systemctl start app")])]),e._v(" "),s("li",[e._v("设置开机启动，"),s("code",[e._v("sudo systemctl enable app")])])]),e._v(" "),s("h2",{attrs:{id:"编写服务描述文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写服务描述文件"}},[e._v("->")]),e._v(" 编写服务描述文件")]),e._v(" "),s("p",[e._v("有点类似yaml的格式，示例如下：")]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("[Unit]\nDescription=Gunicorn instance to serve flask\nAfter=network.target\n\n[Service]\nType=notify\nUser=alex\nGroup=nginx\nWorkingDirectory=/data/home/workspace/myproject\nEnvironment=FLASK_ENV=production REDIS_PASSWORD=xxx MYSQL_PASSWORD=xxxx\nExecStart=/data/home/workspace/myproject/flask/bin/gunicorn --workers 2 --bind unix:app.sock -m 007 app:app\nExecReload=/bin/kill -s HUP $MAINPID\nKillMode=mixed\nTimeoutStopSec=5\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.targe\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br")])]),s("ul",[s("li",[e._v("大小写敏感")]),e._v(" "),s("li",[e._v("基本格式为 "),s("code",[e._v("key=value")]),e._v(", 等号前后的空格会被忽略")]),e._v(" "),s("li",[e._v("注释以 "),s("code",[e._v("#")]),e._v("或者 "),s("code",[e._v(";")]),e._v(" 起始")]),e._v(" "),s("li",[e._v("可使用 "),s("code",[e._v("\\")]),e._v(" 连接多行为一行")]),e._v(" "),s("li",[s("code",[e._v("Unit")]),e._v(" 区块描述一些元信息以及依赖，示例中给出了服务描述和网络依赖，完整的字段描述见 "),s("a",{attrs:{href:"https://www.freedesktop.org/software/systemd/man/systemd.unit.html#%5BUnit%5D%20Section%20Options",target:"_blank",rel:"noopener noreferrer"}},[e._v("systemd.unit"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("code",[e._v("Service")]),e._v(" 区块用来描述 Service的配置")]),e._v(" "),s("li",[s("code",[e._v("Install")]),e._v(" 区块是给 "),s("code",[e._v("systemctl enable|disable")]),e._v(" 用的，用来定义如何启动，以及是否开机启动")])]),e._v(" "),s("p",[e._v("可以看出，重点在 Service部分, 完整的字段描述见 "),s("a",{attrs:{href:"https://www.freedesktop.org/software/systemd/man/systemd.service.html#",target:"_blank",rel:"noopener noreferrer"}},[e._v("systemd.service"),s("OutboundLink")],1)]),e._v(" "),s("ul",[s("li",[s("p",[s("code",[e._v("Type")]),e._v("：定义启动时的进程行为。它有以下几种值。")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("Type=simple")]),e._v("：默认值，执行ExecStart指定的命令，启动主进程")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("Type=forking")]),e._v("：以 fork 方式从父进程创建子进程，创建后父进程会立即退出")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("Type=oneshot")]),e._v("：一次性进程，Systemd 会等当前服务退出，再继续往下执行")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("Type=dbus")]),e._v("：当前服务通过D-Bus启动")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("Type=notify")]),e._v("：当前服务启动完毕，会通知Systemd，再继续往下执行")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("Type=idle")]),e._v("：若有其他任务执行完毕，当前服务才会运行")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("ExecStart")]),e._v("：启动当前服务的命令")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("ExecStartPre")]),e._v("：启动当前服务之前执行的命令")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("ExecStartPost")]),e._v("：启动当前服务之后执行的命令")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("ExecReload")]),e._v("：重启当前服务时执行的命令")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("ExecStop")]),e._v("：停止当前服务时执行的命令")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("ExecStopPost")]),e._v("：停止当其服务之后执行的命令")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("RestartSec")]),e._v("：自动重启当前服务间隔的秒数")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("Restart")]),e._v("：定义何种情况 Systemd 会自动重启当前服务， 默认值是 "),s("code",[e._v("no")]),e._v("， 不会自动重启")]),e._v(" "),s("ul",[s("li",[e._v("可能的值包括"),s("code",[e._v("always")]),e._v("（总是重启）、"),s("code",[e._v("on-success")]),e._v("、"),s("code",[e._v("on-failure")]),e._v("、"),s("code",[e._v("on-abnormal")]),e._v("、"),s("code",[e._v("on-abort")]),e._v("、"),s("code",[e._v("on-watchdog")])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("TimeoutSec")]),e._v("：定义 Systemd 停止当前服务之前等待的秒数")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("Environment")]),e._v("：指定环境变量")]),e._v(" "),s("ul",[s("li",[e._v("可以定义多个环境变量值。eg："),s("code",[e._v("Environment=FLASK_ENV=production REDIS_PASSWORD=xxx MYSQL_PASSWORD=xxxx")])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("EnvironmentFile")]),e._v(": 从单独的文件加载环境变量")])])]),e._v(" "),s("h3",{attrs:{id:"常用服务命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常用服务命令"}},[e._v("->")]),e._v(" 常用服务命令")]),e._v(" "),s("ul",[s("li",[s("code",[e._v("sudo systemctl systemd-analyze verify app.service")]),e._v("， 检查服务文件")]),e._v(" "),s("li",[s("code",[e._v("sudo systemctl start app")]),e._v("， 启动服务")]),e._v(" "),s("li",[s("code",[e._v("sudo systemctl stop app")]),e._v("，  停止服务")]),e._v(" "),s("li",[s("code",[e._v("sudo systemctl status app")]),e._v("， 查看服务状态")]),e._v(" "),s("li",[s("code",[e._v("sudo systemctl reload app")]),e._v("， 重新加载一个服务的配置文件")]),e._v(" "),s("li",[s("code",[e._v("sudo systemctl restart app")]),e._v("， 先 stop再重新 start 服务")]),e._v(" "),s("li",[s("code",[e._v("sudo systemctl kill app")]),e._v("， 杀死一个服务的所有子进程")]),e._v(" "),s("li",[s("code",[e._v("sudo systemctl show app")]),e._v("， 显示服务的所有底层参数")]),e._v(" "),s("li",[s("code",[e._v("sudo systemctl daemon-reload")]),e._v(" service文件有改动时，需要执行该命令重新加载")]),e._v(" "),s("li",[s("code",[e._v("sudo systemctl enable app")]),e._v(", 设置开机启动")]),e._v(" "),s("li",[s("code",[e._v("sudo systemctl disable app")]),e._v(", 禁用开机启动")])]),e._v(" "),s("h2",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[e._v("->")]),e._v(" 参考")]),e._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://fedoraproject.org/wiki/Packaging:Systemd",target:"_blank",rel:"noopener noreferrer"}},[e._v("Systemd"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("systemd-tutorial-commands"),s("OutboundLink")],1)]),e._v(" "),s("li",[s("a",{attrs:{href:"https://www.freedesktop.org/software/systemd/man/systemd.unit.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("systemd-unit"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=_.exports}}]);