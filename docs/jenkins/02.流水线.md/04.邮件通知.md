---
title: Jenkins 邮件通知
date: 2019-10-01
permalink: jenkins/mail
---

Jenkins 内置邮件发送客户端，只需配置邮箱服务器即邮件发送账户密码即可使用
## 配置
在`系统管理` -> `系统配置`页
- 在`Jenkins Location`区域下填写 `系统管理员邮件地址`, 即邮件发送者的邮箱地址
    - eg: `sender@example.com`
    - `Jenkins Notification <sender@example.com>`, 指定显示名
- 在`邮件通知` 或`扩展邮件通知`（安装对应插件）区域（即本页最下方)下填写邮箱配置信息
- 发送测试邮件测试无误即可

## 使用
一般会推荐安装 [Email Extension Plugin](https://jenkins.io/doc/pipeline/steps/email-ext/)，可以指定一些默认选项，比如邮件主题，内容，收件人等

在“自由风格项目”中可直接在构建后的步骤里引用该插件功能，选择触发策略即可。  
本文主要备注在 pipeline脚本中的使用。

### 使用默认邮件功能
在流水线脚本中，通常结合 `post`区块来条件触发

```groovy
post {
    failure {
        mail subject: "Example Build: ${env.JOB_NAME} - Failed", 
            to: 'receiver@example.com', 
            replyTo: 'replyto@example.com', 
            mimeType: 'text/html',
            body: """
                    Job Failed - ${env.JOB_NAME} 
                    build id: ${env.BUILD_NUMBER}
                    View the log at: ${env.BUILD_URL}console
                    Blue Ocean: ${env.RUN_DISPLAY_URL}
                """
    }
}
```
### 使用扩展插件
```groovy
post {
    failure {
        emailext subject: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
          //使用默认收件人配置，也可以使用 "to"来动态指定
          recipientProviders: [[$class: 'DevelopersRecipientProvider']], 
          body: """<p>FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':</p>
            <p>Check console output at &QUOT;<a href='${env.BUILD_URL}'>
            ${env.JOB_NAME} [${env.BUILD_NUMBER}]</a>&QUOT;</p>
            """
    }
}

```

### 使用模板
使用扩展插件的模板功能，默认提供了两个模板
- Text only template: `${SCRIPT, template="groovy-text.template"}`
- HTML template: `${SCRIPT, template="groovy-html.template"}`

也可以自己自定义脚本/模板，放在 `JENKINS_HOME/email-templates/`目录下（不存在可自行创建）  
eg:
```groovy
post {
    failure {
        emailext subject: "FAILED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
          //使用默认收件人配置，也可以使用 "to"来动态指定
          recipientProviders: [[$class: 'DevelopersRecipientProvider']], 
          mimeType: 'text/html',
          //注意body 外层是单引号，此处不是模板插值，不能使用双引号
          body: '${SCRIPT, template="groovy-html.template"}'
          replyTo: "name@exapmle.com",
    }
}
```


```groovy
pipeline {
  agent {label 'dev-win10'}
    options { skipDefaultCheckout() }
    stages {
        stage('test') {
            steps {
                echo "workspace: ${env.WORKSPACE}"
                echo "node: ${env.NODE_NAME}"
                echo "job: ${env.JOB_NAME}"
                echo "BRANCH_NAME: ${env.BRANCH_NAME}"
                echo "author: ${env.CHANGE_AUTHOR}"
                echo "build_id: ${env.BUILD_NUMBER}"
                echo "log: ${env.BUILD_URL}console"
                echo "url: ${env.RUN_DISPLAY_URL}"
                script{
                    scmInfo = checkout scm
                    // echo "scm : ${scmInfo}"
                    echo "${scmInfo.GIT_BRANCH}"
                    echo "${env.WORKSPACE}"
                    // echo "${env.PATH}"
                    result = bat(script: "git log -1 | grep '\\[ci skip\\]'", returnStatus: true)
                    if (result != 0) {
                        echo "performing build..."
                    } else {
                      	echo "${result}"
                        echo "not running..."
                    }
                    bat "node ./test/test.js"
                }
            }
        }
    }
    post {
    	success {
            // emailext body: '${SCRIPT, template="groovy-html.template"}',
            emailext body: '${SCRIPT, template="email.template"}',
                mimeType: 'text/html',
                subject: "[Jenkins] ${env.JOB_NAME}",
                to: "alexli@futunn.com",
                replyTo: "alexli@futunn.com"
                // ${ENV,var="VARIABLENAME"}
                //recipientProviders: [[$class: 'CulpritsRecipientProvider']],
        	    //recipientProviders: [[$class: 'RecipientsRecipientProvider']]
    	}
  	}
}
```

## 参考文档
- [mailer](https://github.com/jenkinsci/mailer-plugin)
- [email-ext wiki](https://wiki.jenkins.io/display/JENKINS/Email-ext+plugin#Email-extplugin-PipelineExamples)
- [groovy-html.template](https://github.com/jenkinsci/email-ext-plugin/blob/master/src/main/resources/hudson/plugins/emailext/templates/groovy-html.template)