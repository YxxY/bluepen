---
title: Jenkins å®‰è£…
permalink: jenkins/install
date: 2019-04-05 00:00:00
categories: 
  - Jenkins
tags: 
  - null
---

Jenkins çš„å®‰è£…ä¸æ˜¯ä¸€ä¸ªå¾ˆéš¾å¾—äº‹æƒ…ï¼Œå®˜ç½‘ä¹Ÿæœ‰[å®‰è£…æ–‡æ¡£](https://jenkins.io/zh/doc/book/installing/)ã€‚  

but, æœ‰ç‚¹å°é—®é¢˜ï¼š
- Dockerçš„æ–¹å¼ï¼Œä¸æ˜¯å¾ˆç†Ÿçš„è¯åç»­ç»´æŠ¤æˆé—®é¢˜ã€‚  
- linuxä¸‹è½½æ•´ä¸ª JenkinsåŒ…å¤ªæ…¢äº†ï¼Œè€Œä¸”å¾ˆå¤šæ—¶å€™å¹¶æ²¡ç”¨å¤–ç½‘ç¯å¢ƒ
- windowsä¸‹å®‰è£…æ˜¯æœ€ç®€å•çš„ï¼Œæ²¡æ¯›ç—…ï¼Œä½†ä¹Ÿç”¨çš„å¾ˆå°‘ğŸ˜‚  

æœ¬æ–‡è®°å½•ä¸‹ linuxä¸‹æ‰‹åŠ¨å®‰è£…çš„æ–¹å¼ï¼Œæ€»çš„æ¥è¯´å…¶å®å°±ä¸¤æ­¥ï¼š
1. å®‰è£… Java
2. ä¸‹è½½ Jenkinsï¼Œä½¿ç”¨ Javaå¯åŠ¨ Jenkins

## æœ€ç®€å•çš„å®‰è£…æ–¹å¼
- å°†[æœ€æ–°çš„ç¨³å®šJenkins WARåŒ…](http://mirrors.jenkins.io/war-stable/latest/jenkins.war) ä¸‹è½½åˆ°æ‚¨è®¡ç®—æœºä¸Šçš„ç›¸åº”ç›®å½•ã€‚
  - å…¶ä»–ä¸‹è½½åœ°å€è§ [https://jenkins.io/zh/download/](https://jenkins.io/zh/download/)
- åœ¨ä¸‹è½½çš„ç›®å½•å†…æ‰“å¼€ä¸€ä¸ªç»ˆç«¯/å‘½ä»¤æç¤ºç¬¦çª—å£åˆ°ã€‚
- è¿è¡Œå‘½ä»¤ `java -jar jenkins.war`
- æµè§ˆhttp://localhost:8080å¹¶ç­‰åˆ°*Unlock Jenkins*é¡µé¢å‡ºç°ã€‚
- åç»­å‡çº§æ›´æ–° waråŒ…ç‰ˆæœ¬å³å¯
**è¯¥æ–¹å¼é»˜è®¤ Javaå·²å®‰è£…å®Œæˆ**ã€‚ä¸‹è½½é€Ÿåº¦ç¨å¾®èƒ½è®©äººæ¥å—ã€‚

## å®‰è£…ä¸ºæœåŠ¡
ç›´æ¥ä»¥ä¸Šæ–‡çš„æ–¹å¼å®‰è£…æ²¡æœ‰é—®é¢˜ï¼Œä½†åœæ­¢å’Œé‡å¯ä¸å¤Ÿä¼˜é›…ï¼Œæ¯”è¾ƒæ¨èçš„æ–¹å¼æ˜¯å®‰è£…ä¸ºjenkins æœåŠ¡ï¼Œå¹¶è®¾ç½®å¼€æœºå¯åŠ¨ã€‚

å¦‚æœæ˜¯ä½¿ç”¨çš„ `init.d` (centos 6)ï¼Œæœ€ç»ˆæœŸæœ›çš„ä½¿ç”¨æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š
- å¯åŠ¨ï¼š`service jenkins start`
- æŸ¥çœ‹çŠ¶æ€ï¼š`service jenkins status`
- é‡å¯ï¼š `service jenkins restart`
- åœæ­¢ï¼š `service jenkins stop`
- è®¾ç½®å¼€æœºå¯åŠ¨ï¼š `chkconfig --add jenkins`
- å–æ¶ˆå¼€æœºå¯åŠ¨ï¼š `chkconfig --del jenkins`

å¦‚æœæ˜¯ä½¿ç”¨çš„ `systemd` (centos 7)ï¼Œä½¿ç”¨æ–¹å¼åˆ™æ˜¯ï¼š
- å¯åŠ¨ï¼š`systemctl start jenkins`
- æŸ¥çœ‹çŠ¶æ€ï¼š`systemctl status jenkins`
- é‡å¯ï¼š `systemctl restart jenkins`
- åœæ­¢ï¼š `systemctl stop jenkins`
- è®¾ç½®å¼€æœºå¯åŠ¨ï¼š`systemctl enable jenkins`
- å–æ¶ˆå¼€æœºå¯åŠ¨ï¼š`systemctl disable jenkins`

å…·ä½“å®ç°å¦‚ä¸‹ï¼š
### ä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼
1. æ–°å»ºä¸€ä¸ª jenkinsç”¨æˆ·ï¼Œä½¿ç”¨è¯¥ç”¨æˆ·æ¥å¯åŠ¨æœåŠ¡
    ```bash
    sudo useradd jenkins
    ```
    ::: tip
    è¯¥æ­¥éª¤éå¿…é¡»ï¼Œæœ‰äººå–œæ¬¢ç”¨ rootæˆ–ä¸ªäººè´¦æˆ·ä¹Ÿå¯ä»¥ï¼Œåªæ˜¯æ¨è
    :::
2. ç¼–å†™ Jenkin é…ç½®æ–‡ä»¶
    - é…ç½®æ–‡ä»¶è·¯å¾„å®šä¸º `/etc/sysconfig/jenkins`
    ```bash
    # Jenkins system configuration
    JENKINS_HOME=/home/jenkins
    JENKINS_USER=jenkins
    JENKINS_LOG=/home/jenkins/jenkins.log
    JENKINS_JAVA=/usr/bin/java
    JENKINS_JAVAOPTS="-Dorg.apache.commons.jelly.tags.fmt.timeZone=Asia/Shanghai \
        -Duser.timezone=Asia/Shanghai -Dfile.encoding=UTF-8 -Djava.awt.headless=true"
    JENKINS_IP=0.0.0.0
    JENKINS_PORT=8080
    JENKINS_ARGS=""
    ```
    - ç»™è¯¥æ–‡ä»¶æ·»åŠ å¯æ‰§è¡Œæƒé™ `sudo chmod +x /etc/sysconfig/jenkins`
    - è®¾ç½® `/home/jenkins`ä¸º jenkinså·¥ä½œç›®å½•ï¼Œ å¹¶è®¾ç½®ä¸ºå…¨å±€ç¯å¢ƒå˜é‡ `JENKINS_HOME`
        - ç¼–è¾‘æ–‡ä»¶ `/etc/profile`, è¿½åŠ ä»¥ä¸‹å†…å®¹
            ```bash
            export JENKINS_HOME=/home/jenkins
            ```
        - `source /etc/profile` ä½¿ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ
    - å°†ä¸‹è½½çš„ `jenkins.war` èµ„æºæ–‡ä»¶æ”¾åœ¨ jenkinså·¥ä½œç›®å½•
    ::: warning
    ç¡®ä¿ JENKINS_USER å¯¹ JENKINS_HOME æœ‰è¯»å†™æƒé™
    :::
3. åœ¨ jenkinså·¥ä½œç›®å½•ç¼–å†™å¯åŠ¨è„šæœ¬ `start-jenkins.sh`
    ```bash
    #!/bin/bash
 
    # import sysconfig settings and set defaults
    [ -f /etc/sysconfig/jenkins ] && . /etc/sysconfig/jenkins
 
    JENKINS_WAR=${JENKINS_HOME}/jenkins.war
 
    # check for config errors
    JENKINS_ERRORS=()
    [ ! -f ${JENKINS_WAR} ] &&
      JENKINS_ERRORS[${#JENKINS_ERRORS[*]}]="JENKINS_HOME : The jenkins.war could not be found at ${JENKINS_HOME}/jenkins.war"
    [ ! -f $JENKINS_JAVA ] &&
      JENKINS_ERRORS[${#JENKINS_ERRORS[*]}]="JENKINS_JAVA : The java executable could not be found at $JENKINS_JAVA"
    
    # display errors if there are any, otherwise start the process
    if [ ${#JENKINS_ERRORS[*]} != '0' ]
    then
      echo "CONFIGURATION ERROR:"
      echo "    The following errors occurred when starting Jenkins."
      echo "    Please set the appropriate values at /etc/sysconfig/jenkins"
      echo ""
      for (( i=0; i<${#JENKINS_ERRORS[*]}; i++ ))
      do
        echo "${JENKINS_ERRORS[${i}]}"
      done
      echo ""
      exit 1
    else
      echo "starting service"
      echo "nohup nice $JENKINS_JAVA $JENKINS_JAVAOPTS -jar $JENKINS_WAR --httpListenAddress=$JENKINS_IP --httpPort=$JENKINS_PORT $> $JENKINS_LOG 2>&1 &"
      nohup nice $JENKINS_JAVA $JENKINS_JAVAOPTS -jar $JENKINS_WAR --httpListenAddress=$JENKINS_IP --httpPort=$JENKINS_PORT $> $JENKINS_LOG 2>&1 &
    fi
    ```
    ::: tip
    æ­¤æ—¶è¯¥è„šæœ¬å°±å¯å¯åŠ¨ jenkinsï¼Œé€šè¿‡è¯»å–é…ç½®æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨nohupä»¥å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨ï¼Œåªæ˜¯ä¸æ˜¯ä¸€ä¸ªç³»ç»ŸæœåŠ¡
    :::
4. åœ¨ jenkinså·¥ä½œç›®å½•ç¼–å†™åœæ­¢è„šæœ¬ `stop-jenkins.sh`
    ```bash
    #!/bin/bash
    kill `ps -ef | grep [j]enkins.war | awk '{ print $2 }'`
    ```
5. å®‰è£…ä¸ºæœåŠ¡å¹¶è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨
    - ç¼–å†™æœåŠ¡è„šæœ¬ï¼Œè·¯å¾„ä¸º `/etc/init.d/jenkins`
    ```bash
    #! /bin/bash
    # chkconfig: 2345 90 10
    # description: Jenkins Continuous Integration server

    # Source function library.
    . /etc/rc.d/init.d/functions
    
    # Get network sysconfig.
    . /etc/sysconfig/network
    
    # Check that networking is up, otherwise we can't start
    [ "${NETWORKING}" = "no" ] && exit 0
    
    # Get the Jenkins sysconfig
    [ -f /etc/sysconfig/jenkins ] && . /etc/sysconfig/jenkins
    
    startup=${JENKINS_HOME}/start-jenkins.sh
    shutdown=${JENKINS_HOME}/stop-jenkins.sh
    
    start(){
      echo -n $"Starting Jenkins service: "
      pid=`ps -ef | grep [j]enkins.war | grep -v grep | wc -l`
      if [ $pid -gt 0 ]; then
        echo "Jenkins is already running"
        exit 1
      fi
      su - $JENKINS_USER -c $startup
      RETVAL=$?
      [ $RETVAL == 0 ] &&
        echo "Jenkins was started successfully." ||
        echo "There was an error starting Jenkins."
    }
    
    stop(){
      action $"Stopping Jenkins service: "
      pid=`ps -ef | grep [j]enkins.war | grep -v grep | wc -l`
      if [ ! $pid -gt 0 ]; then
        echo "Jenkins is not running"
        exit 1
      fi
      su - $JENKINS_USER -c $shutdown
      RETVAL=$?
      [ $RETVAL == 0 ] &&
        echo "Jenkins was stopped successfully." ||
        echo "There was an error stopping Jenkins."
    }
    
    status(){
      pid=`ps -ef | grep [j]enkins.war | grep -v grep | wc -l`
      if [ $pid -gt 0 ]; then
        echo "Jenkins is running..."
      else
        echo "Jenkins is stopped..."
      fi
    }
    
    restart(){
      stop
      sleep 5
      start
    }
    
    # Call functions as determined by args.
    case "$1" in
    start)
      start;;
    stop)
      stop;;
    status)
      status;;
    restart)
      restart;;
    *)
      echo $"Usage: $0 {start|stop|status|restart}"
      exit 1
    esac
    
    exit 0
    ```
    - ç»™å¯åŠ¨è„šæœ¬ï¼Œåœæ­¢è„šæœ¬ï¼ŒæœåŠ¡è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
    ```bash
    chmod a+x /home/jenkins/start-jenkins.sh
    chmod a+x /home/jenkins/stop-jenkins.sh
    chmod a+x /etc/init.d/jenkins
    ```

åˆ°è¿™é‡Œå³å¯è¿è¡Œ `service jenkins start`å‘½ä»¤å¯åŠ¨ jenkinsæœåŠ¡äº†

### systemd æœåŠ¡
centos 7å·²ç»ä½¿ç”¨ systemdæ¥åšç³»ç»Ÿåˆå§‹åŒ–äº†ï¼Œåœ¨ centos 7ç­‰ç³»ç»Ÿä¸Šå®‰è£…æœåŠ¡ä¸Šé¢çš„æ–¹å¼ä¸é€‚ç”¨ï¼Œä½†å¾ˆå¤šåœ°æ–¹å¯ä»¥å¤ç”¨ã€‚

å‰é¢çš„æ­¥éª¤ç›¸åŒï¼Œè¿˜éœ€é¢å¤–åˆ›å»º systemdçš„æœåŠ¡è„šæœ¬, è„šæœ¬è·¯å¾„ä¸º `/lib/systemd/system/jenkins.service`
```ini
[Unit]  
Description=Jenkins Continuous Integration server  
After=network.target  

[Service]  
ExecStart=/etc/init.d/jenkins start  
ExecReload=/etc/init.d/jenkins restart  
ExecStop=/etc/init.d/jenkins stop  
Restart=on-failure

[Install]  
WantedBy=multi-user.target  
```
::: tip
ä¿®æ”¹ serviceæ–‡ä»¶åéœ€è¿è¡Œå‘½ä»¤ `sudo systemctl daemon-reload`ä½¿ç”Ÿæ•ˆ
:::

å¦‚æœä½¿è¿™æ ·è¿è¡Œå¯åŠ¨å‘½ä»¤ `systemctl start jenkins`, å†é€šè¿‡ `systemctl status jenkins`æŸ¥çœ‹æœåŠ¡ä¼šå‘ç° jenkinsæœåŠ¡å¯åŠ¨æˆåŠŸåç«‹åˆ»åœæ­¢ã€‚

StackOverflow äº†ä»¥ä¸‹ï¼Œä¼¼æ‡‚éæ‡‚ï¼Œå¤§æ¦‚æ˜¯ systemdç®¡ç†è¿›ç¨‹çš„æ–¹å¼å·²ç»å˜äº†ï¼Œå¦‚æœè¿˜æ˜¯ç”¨ä¹‹å‰çš„å®ˆæŠ¤è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨ï¼Œsystemdæ— æ³•è·å–å®ƒçš„çŠ¶æ€ä¿¡æ¯ã€‚  
å› æ­¤ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œå°†å¯åŠ¨æ–¹å¼æ”¹æˆæ™®é€šçš„è¿›ç¨‹å¯åŠ¨æ–¹å¼å³å¯ï¼Œä¸å†ä½¿ç”¨ nohupå³å¯è§£å†³è¯¥é—®é¢˜ã€‚

å³ï¼Œå°† `start-jenkins.sh` è„šæœ¬çš„ç¬¬ 31è¡Œï¼Œä»
```bash
nohup nice $JENKINS_JAVA $JENKINS_JAVAOPTS -jar $JENKINS_WAR --httpListenAddress=$JENKINS_IP --httpPort=$JENKINS_PORT $> $JENKINS_LOG 2>&1 &
```
æ”¹ä¸º
```bash
$JENKINS_JAVA $JENKINS_JAVAOPTS -jar $JENKINS_WAR --httpListenAddress=$JENKINS_IP --httpPort=$JENKINS_PORT $> $JENKINS_LOG 2>&1
```
å³å¯ã€‚  
å¹¶ä¸”è¿˜æ”¶è·äº†æ„å¤–é€€å‡ºå¯è‡ªåŠ¨é‡å¯çš„åŠŸèƒ½ï¼Œç¡®å®åŠŸèƒ½æ›´å¼ºå¤§äº†ã€‚

    

## å‚è€ƒæ–‡æ¡£
- 
- [install jenkins as a service on centos6](https://www.justinsilver.com/technology/linux/install-jenkins-centos-service/)
- [systemd service faq](https://superuser.com/questions/1022142/why-is-systemd-stopping-service-immediately-after-it-is-started)


